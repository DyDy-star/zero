========================================
GPU 配置修改总结（3-GPU 模式）
========================================

日期: 2025-12-08
修改原因: 只能使用 GPU 1,2,3，不能使用 GPU 0

========================================
修改的文件清单
========================================

1. fix_training_and_restart.sh
   修改: CUDA_VISIBLE_DEVICES=0,1,2,3 → 1,2,3

2. scripts/main_3iterations_4gpu.sh
   修改: CUDA_VISIBLE_DEVICES=0,1,2,3 → 1,2,3
   添加说明: 物理编号将映射为内部0,1,2

3. start_training_4gpu.sh
   修改: CUDA_VISIBLE_DEVICES=0,1,2,3 → 1,2,3

4. vllm_service_init/start.sh
   修改: 
   - GPU 2,3 → GPU 2（单GPU）
   - gpu_mem_util: 0.9 → 0.45（两个服务共享）
   - 添加说明注释

5. question_generate/question_generate.bash
   修改: 保持 CUDA_VISIBLE_DEVICES=2（内部编号）
   添加: 说明注释

6. question_evaluate/evaluate.sh
   修改: 保持 CUDA_VISIBLE_DEVICES=2（内部编号）
   添加: 说明注释

========================================
GPU 映射关系
========================================

物理GPU编号 → 内部GPU编号
    1       →     0
    2       →     1
    3       →     2

代码中使用内部编号！

========================================
GPU 分配策略
========================================

Questioner 训练:
  - 训练: 内部GPU 0,1（物理1,2）
  - vLLM: 内部GPU 2（物理3），共享

Solver 训练:
  - 问题生成: 内部GPU 2（物理3）
  - 问题评估: 内部GPU 2（物理3）
  - 模型训练: 所有GPU（内部0,1,2）

========================================
关键变化
========================================

1. vLLM 服务从 2 个独立 GPU → 共享 1 个 GPU
   - 两个服务各用 45% 显存
   - 可能影响推理速度

2. 训练可用 GPU 从 4 个 → 3 个
   - Questioner: 仍用 2 个GPU（不变）
   - Solver: 从 4 个减少到 3 个
   - 预计训练时间增加 10-20%

========================================
验证命令
========================================

# 1. 检查环境变量设置
grep "CUDA_VISIBLE_DEVICES=1,2,3" fix_training_and_restart.sh

# 2. 检查 vLLM 配置
cat vllm_service_init/start.sh | grep "gpu_mem_util"

# 3. 测试 GPU 可见性
export CUDA_VISIBLE_DEVICES=1,2,3
python -c "import torch; print(f'GPU数量: {torch.cuda.device_count()}')"

# 4. 查看当前 GPU 状态
nvidia-smi | grep -A 2 "GPU.*1\|2\|3"

========================================
启动训练
========================================

cd /data/user5/R-Zero
bash fix_training_and_restart.sh

脚本会自动使用正确的 GPU 配置！

========================================
文档
========================================

详细说明: GPU配置说明_3GPU.md

========================================

